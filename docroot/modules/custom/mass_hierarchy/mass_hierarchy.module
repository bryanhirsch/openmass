<?php

/**
 * @file
 * Contains mass_hierarchy.module.
 */

use Drupal\Core\Form\FormState;

/**
 * Builds what bundles are supported to parents of the available bundles.
 */
function mass_hierarchy_get_parent_bundle_info() {
  /** @var Drupal\Core\Entity\EntityTypeBundleInfo */
  $entity_type_bundle_info_service = \Drupal::service('entity_type.bundle.info');
  $bundles = $entity_type_bundle_info_service->getBundleInfo('node');

  /** @var \Drupal\Core\Entity\EntityFieldManager */
  $entity_field_manager_service = \Drupal::getContainer()->get('entity_field.manager');

  foreach ($bundles as $bundle_name => $bundle_info) {
    $field_definitions = $entity_field_manager_service->getFieldDefinitions('node', $bundle_name);
    if (!isset($field_definitions['field_primary_parent'])) {
      continue;
    }
    $info[$bundle_name] = $field_definitions['field_primary_parent']->getSetting('handler_settings')['target_bundles'];
  }
  return $info;
}

/**
 * Implements hook_form_alter().
 */
function mass_hierarchy_form_alter(&$form, FormState $form_state, $form_id) {
  if (strpos($form_id, '_entity_hierarchy_reorder_form') !== FALSE) {
    mass_hierarchy_form_any_form_entity_hierarchy_reorder_form_alter($form, $form_state, $form_id);
  }
}

/**
 * To validate (front-end) parent/child relationships on the hierarchy form.
 */
function mass_hierarchy_form_any_form_entity_hierarchy_reorder_form_alter(&$form, FormState $form_state, $form_id) {
  $form['#attached']['drupalSettings']['mass_hierarchy_parent_bundle_info'] = mass_hierarchy_get_parent_bundle_info();
}
